{{/* RESIZE RESOURCE IMAGES, THEN CREATE SRCSET TAGS. ENABLE LAZY LOADING NATIVE/JS AND NOSCRIPT SUPPORT */}}
{{/* USE {{ partial "scripts/srcset.html" (dict "page" . "image" "image_name" "class" "class_names with spaces")}} */}}
{{/* .md file must have resources set up including 
  - src (e.g. images/testimonials*), 
    title: (used for alt text), 
    name: (optional override, defaults to file name), 
    params: 
      class: " " (optional)
      eager: true (for above the fold)
      small: true (for small image resizing)
      slide: true  (for slider image resizing)   */}}


{{ $image := .page.Resources.GetMatch (printf "*%s*" .image ) }}

{{ $imageSize := imageConfig ($image.RelPermalink | printf "content/%s" ) }}
{{ $lqip := $image.Resize .Site.Params.lqipWidth -}}
{{ $lqipConfig := imageConfig ($image.RelPermalink | printf "content/%s" ) }}

<!-- variables used for img tag -->
{{ $imgSrc := "" }}
{{ $imgSrcSet := slice }}
{{ $widths := ""}}

{{ if $image.Params.widthCols }}
  {{ $widths = site.Params.photoWidthCols }}
{{ else if $image.Params.widthThumbs }}
  {{ $widths = site.Params.photoWidthThumbs }}
{{ else }}
  {{ $widths = site.Params.photoWidthFull }}
{{ end }}

<!-- uses settings from config.toml depending on orientation -->
  {{/*  {{ $widths = site.Params.landscapePhotoWidths }}
  {{ if gt $image.Height $image.Width }}
    {{ $widths = site.Params.portraitPhotoWidths }}
  {{ end }}
{{ end }}  */}}

<!--
  Add URL for each width to $imgSrcSet variable
  format: "/path/img_1000.jpg 1000w,/path/img_500.jpg 500w"
  Note: the first URL is used as "fallback" src in $imgSrc.
-->
{{ range $widths }}
  {{ $srcUrl := (printf "%dx" . | $image.Resize).RelPermalink }}
  {{ if eq $imgSrc "" }}
    {{ $imgSrc = $srcUrl }}
  {{ end }}
  {{ $imgSrcSet = $imgSrcSet | append (printf "%s %dw" $srcUrl .) }}
{{ end }}
{{ $imgSrcSet = (delimit $imgSrcSet ",") }}

{{/*  OUTPUT HTML  */}}
{{- if $image.Params.figure -}}
<figure class="figure">
{{- end -}}
{{ if eq $image.MediaType.SubType "svg" }}
  {{ if $image.Params.eager }} 
    <img alt="{{ $image.Title }}" 
      class="img-fluid {{ $image.Params.class }} {{ $.class }}" 
      src="{{ $image.RelPermalink }}" />
  {{ else -}}
    <img alt="{{- $image.Title -}}" 
      class="lazyload {{ $image.Params.class }} {{ $.class }}" 
      data-sizes="auto"
      data-src= "{{ $image.RelPermalink -}}"  />
  {{ end }}
{{ else }}
  {{ if $image.Params.eager }} 
  <img alt="{{- $image.Title -}}" 
    class="lazyload {{ $image.Params.class }} {{ .Get "class" }}" 
    data-sizes="auto"
    srcset="{{- $imgSrcSet -}}"
    src="{{- $image.RelPermalink -}}"
    loading="eager" />
  {{ else -}}
  <img alt="{{- $image.Title -}}" 
    class="lazyload {{ $image.Params.class }}  {{ .Get "class" }}" 
    data-sizes="auto"
    data-srcset="{{- $imgSrcSet -}}"
    src="{{- $image.RelPermalink -}}"
    srcset="data:image/gif;base64,{{- $lqip.Content | base64Encode -}}"  />
  {{ end }}
  {{ if $image.Params.figure -}}
  <figcaption class="figure-caption">{{ $image.Title }}</figcaption>
  </figure>
  {{ end }}
  <noscript>
    {{- if $image.Params.figure -}}
    <figure class="figure">
    {{- end -}}
    <img alt="{{- $image.Title -}}" 
    class="img-fluid {{ $image.Params.class }} {{ .Get "class" }}" 
    src="{{- $image.RelPermalink -}}" />
    {{ if $image.Params.figure -}}
    <figcaption class="figure-caption">{{ $image.Title }}</figcaption>
    </figure>
    {{ end }}
  </noscript>
{{ end }}